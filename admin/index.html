<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel - MB Engineering</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        /* Additional admin styles */
        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .admin-tab {
            padding: 0.75rem 1.5rem;
            border: 2px solid #000;
            background: #000;
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .admin-tab:hover {
            background: #333;
        }
        .admin-tab.active {
            background: #fff;
            color: #000;
            border-color: #000;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .items-list {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .list-item img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }
        .list-item-info {
            flex: 1;
        }
        .list-item-info h4 {
            margin: 0 0 0.25rem 0;
        }
        .list-item-info p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        .list-item-info .date {
            font-size: 0.8rem;
            color: #999;
        }
        .list-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn-edit, .btn-delete {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .btn-edit {
            background: #0066cc;
            color: white;
        }
        .btn-edit:hover {
            background: #0052a3;
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background: #c82333;
        }
        .form-mode-indicator {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .form-mode-indicator.create-mode {
            background: #d4edda;
            color: #155724;
        }
        .form-mode-indicator.edit-mode {
            background: #fff3cd;
            color: #856404;
        }
        .btn-cancel {
            background: #6c757d;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 1rem;
        }
        .btn-cancel:hover {
            background: #5a6268;
        }
        .current-image-preview {
            margin: 0.5rem 0;
        }
        .current-image-preview img {
            max-width: 200px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .current-image-preview p {
            font-size: 0.85rem;
            color: #666;
            margin: 0.25rem 0;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        .no-items {
            text-align: center;
            padding: 2rem;
            color: #666;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .btn-insert-image,
        .btn-insert-video {
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        .btn-insert-image {
            background: #28a745;
        }
        .btn-insert-image:hover {
            background: #218838;
        }
        .btn-insert-video {
            background: #6f42c1;
        }
        .btn-insert-video:hover {
            background: #5a32a3;
        }
        .btn-insert-image:disabled,
        .btn-insert-video:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .textarea-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        .placeholder-img {
            width: 80px;
            height: 60px;
            background: #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.75rem;
        }
        .form-actions {
            display: flex;
            align-items: center;
            margin-top: 1rem;
        }
        .btn-primary {
            background: #000;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
        }
        .btn-primary:hover {
            background: #333;
        }
        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        /* Profile photo editor */
        .profile-photo-editor {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .about-avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            background-color: #e9ecef;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            flex-shrink: 0;
        }
        .profile-photo-actions {
            flex: 1;
        }
        .profile-photo-hint {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }
        /* Color picker rows */
        .color-row {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
        .color-row > div {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .color-row input[type="color"] {
            width: 60px;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        /* Admin timeline editor */
        .timeline-editor-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 0.75rem;
        }
        .timeline-editor-item {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.9rem 1rem;
            background: #f9fafb;
        }
        .timeline-editor-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .timeline-editor-row input {
            flex: 1;
        }
        .timeline-editor-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #6b7280;
            margin-bottom: 0.15rem;
        }
        .timeline-editor-item textarea {
            width: 100%;
            resize: vertical;
        }
        .timeline-editor-remove {
            margin-top: 0.4rem;
            font-size: 0.85rem;
            color: #b91c1c;
            background: none;
            border: none;
            cursor: pointer;
        }
        .timeline-editor-remove:hover {
            text-decoration: underline;
        }
        .btn-move {
            background: #e5e7eb;
            color: #374151;
            border: none;
            padding: 0.35rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-move:hover {
            background: #d1d5db;
        }
        .btn-secondary {
            background: #6b7280;
            color: #fff;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>

    <div id="login-container">
        <div class="login-box">
            <h1>Admin Login</h1>
            <button id="login-button" class="login-btn">Log In</button>
        </div>
    </div>

    <div id="admin-content" style="display: none;">
        <header>
            <h1>Admin Panel</h1>
            <div id="user-info"></div>
            <button id="logout-button" class="logout-btn">Log Out</button>
        </header>

        <main>
            <!-- Tab Navigation -->
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="projects">Project Gallery</button>
                <button class="admin-tab" data-tab="blog">Blog Posts</button>
                <button class="admin-tab" data-tab="about">About Me</button>
                <button class="admin-tab" data-tab="resume">Resume</button>
                <button class="admin-tab" data-tab="contact">Contact</button>
                <button class="admin-tab" data-tab="site">Site Settings</button>
            </div>

            <!-- ===================== PROJECTS TAB ===================== -->
            <div id="projects-tab" class="tab-content active">
                
                <!-- Existing Projects List -->
                <div class="form-container">
                    <h2>Your Projects</h2>
                    <div id="projects-list" class="items-list">
                        <div class="loading">Loading projects...</div>
                    </div>
                </div>

                <!-- Create/Edit Project Form -->
                <div class="form-container">
                    <div id="project-form-mode" class="form-mode-indicator create-mode">
                        ‚ú® Creating New Project
                    </div>
                    <h2 id="project-form-title">Create New Project</h2>
                    <form id="projectForm">
                        <input type="hidden" id="projectId" value="">

                        <label for="projectTitle">Title:</label>
                        <input type="text" id="projectTitle" required>

                        <label for="projectSummary">Summary:</label>
                        <input type="text" id="projectSummary" placeholder="Short one-line description for the gallery card">

                        <label for="projectImage">Hero Image:</label>
                        <div id="projectCurrentImagePreview" class="current-image-preview" style="display: none;">
                            <p>Current image:</p>
                            <img id="projectCurrentImage" src="" alt="Current hero image">
                            <p><em>Upload a new image to replace, or leave empty to keep current.</em></p>
                        </div>
                        <input type="file" id="projectImage" accept="image/*">

                        <label for="projectContent">Full Project Content (Markdown):</label>
                        <div class="textarea-toolbar">
                            <button type="button" id="projectInsertImageBtn" class="btn-insert-image">üì∑ Insert Inline Image...</button>
                            <button type="button" id="projectInsertVideoBtn" class="btn-insert-video">üé¨ Insert Inline Video...</button>
                        </div>
                        <textarea id="projectContent" rows="15" placeholder="Write a detailed breakdown here. You can use Markdown."></textarea>

                        <div class="form-actions">
                            <button type="submit" id="projectSubmitBtn">Create Project</button>
                            <button type="button" id="projectCancelEdit" class="btn-cancel" style="display: none;">Cancel Edit</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ===================== BLOG TAB ===================== -->
            <div id="blog-tab" class="tab-content">
                
                <!-- Existing Blog Posts List -->
                <div class="form-container">
                    <h2>Your Blog Posts</h2>
                    <div id="blog-list" class="items-list">
                        <div class="loading">Loading blog posts...</div>
                    </div>
                </div>

                <!-- Create/Edit Blog Post Form -->
                <div class="form-container">
                    <div id="blog-form-mode" class="form-mode-indicator create-mode">
                        ‚ú® Creating New Blog Post
                    </div>
                    <h2 id="blog-form-title">Create New Blog Post</h2>
                    <form id="blogForm">
                        <input type="hidden" id="blogId" value="">

                        <label for="blogTitle">Title:</label>
                        <input type="text" id="blogTitle" required>

                        <label for="blogSummary">Summary:</label>
                        <input type="text" id="blogSummary" placeholder="Short description for the blog list">

                        <label for="blogHeroImage">Hero Image:</label>
                        <div id="blogCurrentImagePreview" class="current-image-preview" style="display: none;">
                            <p>Current image:</p>
                            <img id="blogCurrentImage" src="" alt="Current hero image">
                            <p><em>Upload a new image to replace, or leave empty to keep current.</em></p>
                        </div>
                        <input type="file" id="blogHeroImage" accept="image/*">

                        <label for="blogContent">Full Blog Content (Markdown):</label>
                        <div class="textarea-toolbar">
                            <button type="button" id="blogInsertImageBtn" class="btn-insert-image">üì∑ Insert Inline Image...</button>
                            <button type="button" id="blogInsertVideoBtn" class="btn-insert-video">üé¨ Insert Inline Video...</button>
                        </div>
                        <textarea id="blogContent" rows="15" placeholder="Write your blog post here using Markdown."></textarea>

                        <div class="form-actions">
                            <button type="submit" id="blogSubmitBtn">Create Blog Post</button>
                            <button type="button" id="blogCancelEdit" class="btn-cancel" style="display: none;">Cancel Edit</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ===================== ABOUT ME TAB ===================== -->
            <div id="about-tab" class="tab-content">
                <div class="form-container">
                    <h2>Edit About Me Page</h2>
                    <p style="color: #666; margin-bottom: 1.5rem;">This content appears on your public About page.</p>
                    
                    <label for="aboutTitle">Page Title:</label>
                    <input type="text" id="aboutTitle" value="About">

                    <label for="aboutTagline">Tagline:</label>
                    <input type="text" id="aboutTagline" placeholder="e.g., Electrical Engineering Technologist ¬∑ R&D ¬∑ Prototyping">

                    <label>Profile Photo:</label>
                    <div class="profile-photo-editor">
                        <div id="aboutProfilePreview" class="about-avatar-preview"></div>
                        <div class="profile-photo-actions">
                            <input type="file" id="aboutProfileInput" accept="image/*" style="display:none;">
                            <button type="button" id="aboutProfileUploadBtn" class="btn-insert-image">üì∑ Upload Profile Photo</button>
                            <p class="profile-photo-hint">This image appears as the circular portrait on the About page.</p>
                        </div>
                    </div>
                    <input type="hidden" id="aboutProfileImageUrl">

                    <label for="aboutContent">Content (Markdown):</label>
                    <div class="textarea-toolbar">
                        <button type="button" id="aboutInsertImageBtn" class="btn-insert-image">üì∑ Insert Inline Image...</button>
                        <button type="button" id="aboutInsertVideoBtn" class="btn-insert-video">üé¨ Insert Inline Video...</button>
                    </div>
                    <textarea id="aboutContent" rows="15" placeholder="Write about yourself using Markdown."></textarea>

                    <hr style="margin: 2rem 0;" />

                    <h3>About Timeline</h3>
                    <p style="color:#666; margin-bottom: 1rem;">
                        Each entry becomes a step in the timeline on your About page.
                    </p>

                    <div id="aboutTimelineList" class="timeline-editor-list">
                        <!-- timeline editor items injected by admin.js -->
                    </div>

                    <button type="button" id="aboutTimelineAddBtn" class="btn-secondary" style="margin-top: 1rem;">
                        + Add Timeline Entry
                    </button>

                    <div class="form-actions" style="margin-top: 2rem;">
                        <button type="button" id="aboutSaveBtn" class="btn-primary">Save About Page</button>
                    </div>
                    <p id="aboutLastSaved" style="color: #666; font-size: 0.85rem; margin-top: 1rem;"></p>
                </div>
            </div>

            <!-- ===================== RESUME TAB ===================== -->
            <div id="resume-tab" class="tab-content">
                <div class="form-container">
                    <h2>Edit Resume Page</h2>
                    <p style="color: #666; margin-bottom: 1.5rem;">Upload your resume and customize the page content.</p>
                    
                    <label for="resumeTitle">Page Title:</label>
                    <input type="text" id="resumeTitle" value="Resume">

                    <label for="resumeIntro">Intro Text:</label>
                    <textarea id="resumeIntro" rows="3" placeholder="You can view or download my resume below."></textarea>

                    <label>Resume File:</label>
                    <div id="resumeCurrentFile" class="current-image-preview" style="display:none;">
                        <p><strong>Current resume file:</strong></p>
                        <p id="resumeFileName" style="font-size:0.9rem; color:#333;"></p>
                        <a id="resumeFileLink" href="#" target="_blank" rel="noopener" style="color:#0066cc;">Open in new tab ‚Üí</a>
                    </div>
                    <input type="file" id="resumeFileInput" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                    <p style="font-size:0.8rem; color:#666; margin-top:0.25rem;">Accepts PDF, DOC, or DOCX files</p>

                    <div class="form-actions">
                        <button type="button" id="resumeSaveBtn" class="btn-primary">Save Resume Page</button>
                    </div>
                    <p id="resumeLastSaved" style="color: #666; font-size: 0.85rem; margin-top: 1rem;"></p>
                </div>
            </div>

            <!-- ===================== CONTACT TAB ===================== -->
            <div id="contact-tab" class="tab-content">
                <div class="form-container">
                    <h2>Edit Contact Page</h2>
                    <p style="color: #666; margin-bottom: 1.5rem;">
                        Update your contact information and intro text.
                    </p>

                    <label for="contactTitle">Page Title:</label>
                    <input type="text" id="contactTitle" value="Contact">

                    <label for="contactIntroInput">Intro Text:</label>
                    <textarea id="contactIntroInput" rows="2" placeholder="Let's connect."></textarea>

                    <label for="contactEmail">Contact Email:</label>
                    <input type="email" id="contactEmail" placeholder="youremail@example.com">

                    <label for="contactBodyInput">Body Content (Markdown allowed):</label>
                    <textarea id="contactBodyInput" rows="5" placeholder="Add any additional information..."></textarea>

                    <div class="form-actions">
                        <button type="button" id="contactSaveBtn" class="btn-primary">
                            Save Contact Page
                        </button>
                    </div>
                    <p id="contactLastSaved" style="color: #666; font-size: 0.85rem; margin-top: 1rem;"></p>
                </div>
            </div>

            <!-- ===================== SITE SETTINGS TAB ===================== -->
            <div id="site-tab" class="tab-content">
                <div class="form-container">
                    <h2>Site Settings</h2>
                    <p style="color: #666; margin-bottom: 1.5rem;">
                        Control the site title, tagline, and theme colors used in the header and background.
                    </p>

                    <label for="siteTitle">Site Title (top header):</label>
                    <input type="text" id="siteTitle" placeholder="MB Engineering">

                    <label for="siteSubtitle">Site Subtitle:</label>
                    <input type="text" id="siteSubtitle" placeholder="Your Name | Engineering Technologist">

                    <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">Theme Colors</h3>

                    <div class="color-row">
                        <div>
                            <label for="headerBg">Header Background:</label>
                            <input type="color" id="headerBg" value="#333333">
                        </div>
                        <div>
                            <label for="headerText">Header Text:</label>
                            <input type="color" id="headerText" value="#ffffff">
                        </div>
                    </div>

                    <div class="color-row">
                        <div>
                            <label for="pageBg">Page Background:</label>
                            <input type="color" id="pageBg" value="#f5f5f5">
                        </div>
                        <div>
                            <label for="cardBg">Card Background:</label>
                            <input type="color" id="cardBg" value="#ffffff">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="siteSaveBtn" class="btn-primary">Save Site Settings</button>
                    </div>
                    <p id="siteLastSaved" style="color: #666; font-size: 0.85rem; margin-top: 1rem;"></p>
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden file inputs for inline uploads -->
    <input type="file" id="inlineImageInput" accept="image/*" style="display: none;">
    <input type="file" id="projectVideoInput" accept="video/*" style="display: none;">
    <input type="file" id="blogVideoInput" accept="video/*" style="display: none;">

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const loginContainer = document.getElementById('login-container');
        const adminContent = document.getElementById('admin-content');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const userInfo = document.getElementById('user-info');

        // ==================== SHARED UTILITIES ====================
        
        function insertAtCursor(textarea, text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);
            textarea.value = before + text + after;
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
            textarea.focus();
        }

        async function uploadFile(file) {
            const base64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });

            const response = await fetch('/.netlify/functions/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file.name, content: base64 })
            });
            
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Failed to upload file.');
            return result.imageUrl;
        }

        const uploadImage = uploadFile;

        function getVideoMimeType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const mimeTypes = { 'mp4': 'video/mp4', 'webm': 'video/webm', 'mov': 'video/quicktime', 'ogg': 'video/ogg' };
            return mimeTypes[ext] || 'video/mp4';
        }

        // ==================== INLINE IMAGE INSERTION ====================
        
        const inlineImageInput = document.getElementById('inlineImageInput');
        let currentInlineTarget = null;

        inlineImageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !currentInlineTarget) return;

            const btn = currentInlineTarget.btn;
            const textarea = currentInlineTarget.textarea;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Uploading...';
                const imageUrl = await uploadFile(file);
                insertAtCursor(textarea, `\n\n![image description](${imageUrl})\n\n`);
                btn.textContent = '‚úÖ Inserted!';
                setTimeout(() => { btn.textContent = 'üì∑ Insert Inline Image...'; btn.disabled = false; }, 1500);
            } catch (error) {
                console.error('Inline image upload error:', error);
                alert(`Error: ${error.message}`);
                btn.textContent = 'üì∑ Insert Inline Image...';
                btn.disabled = false;
            }
            
            inlineImageInput.value = '';
            currentInlineTarget = null;
        });

        // ==================== INLINE VIDEO INSERTION ====================
        
        const projectVideoInput = document.getElementById('projectVideoInput');
        const blogVideoInput = document.getElementById('blogVideoInput');
        let currentVideoTarget = null;

        async function handleVideoUpload(e) {
            const file = e.target.files[0];
            if (!file || !currentVideoTarget) return;

            const btn = currentVideoTarget.btn;
            const textarea = currentVideoTarget.textarea;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Uploading video...';
                const videoUrl = await uploadFile(file);
                const mimeType = getVideoMimeType(file.name);
                const videoHtml = `\n\n<video controls width="100%">\n  <source src="${videoUrl}" type="${mimeType}">\n  Your browser does not support the video tag.\n</video>\n\n`;
                insertAtCursor(textarea, videoHtml);
                btn.textContent = '‚úÖ Inserted!';
                setTimeout(() => { btn.textContent = 'üé¨ Insert Inline Video...'; btn.disabled = false; }, 1500);
            } catch (error) {
                console.error('Video upload error:', error);
                alert(`Error: ${error.message}`);
                btn.textContent = 'üé¨ Insert Inline Video...';
                btn.disabled = false;
            }
            
            e.target.value = '';
            currentVideoTarget = null;
        }

        projectVideoInput.addEventListener('change', handleVideoUpload);
        blogVideoInput.addEventListener('change', handleVideoUpload);

        // ==================== PROJECTS ====================
        
        const projectForm = document.getElementById('projectForm');
        const projectsList = document.getElementById('projects-list');
        const projectIdField = document.getElementById('projectId');
        const projectTitleField = document.getElementById('projectTitle');
        const projectSummaryField = document.getElementById('projectSummary');
        const projectContentField = document.getElementById('projectContent');
        const projectImageField = document.getElementById('projectImage');
        const projectCurrentImagePreview = document.getElementById('projectCurrentImagePreview');
        const projectCurrentImage = document.getElementById('projectCurrentImage');
        const projectFormMode = document.getElementById('project-form-mode');
        const projectFormTitle = document.getElementById('project-form-title');
        const projectSubmitBtn = document.getElementById('projectSubmitBtn');
        const projectCancelEditBtn = document.getElementById('projectCancelEdit');
        const projectInsertImageBtn = document.getElementById('projectInsertImageBtn');
        const projectInsertVideoBtn = document.getElementById('projectInsertVideoBtn');

        let currentEditingProject = null;
        let allProjects = [];

        projectInsertImageBtn.addEventListener('click', () => {
            currentInlineTarget = { btn: projectInsertImageBtn, textarea: projectContentField };
            inlineImageInput.click();
        });

        projectInsertVideoBtn.addEventListener('click', () => {
            currentVideoTarget = { btn: projectInsertVideoBtn, textarea: projectContentField };
            projectVideoInput.click();
        });

        async function loadProjects() {
            projectsList.innerHTML = '<div class="loading">Loading projects...</div>';
            try {
                const response = await fetch('/.netlify/functions/getprojects');
                if (!response.ok) throw new Error('Failed to load projects');
                allProjects = await response.json();
                renderProjectsList();
            } catch (error) {
                console.error('Error loading projects:', error);
                projectsList.innerHTML = '<div class="no-items">Error loading projects. Please refresh.</div>';
            }
        }

        function renderProjectsList() {
            if (allProjects.length === 0) {
                projectsList.innerHTML = '<div class="no-items">No projects yet. Create your first one below!</div>';
                return;
            }
            const sorted = [...allProjects].sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
            projectsList.innerHTML = sorted.map(project => {
                const imageUrl = project.heroImage || project.imageUrl || project.image || '';
                const summary = project.summary || project.description || 'No summary';
                const date = project.createdAt ? new Date(project.createdAt).toLocaleDateString() : '';
                return `
                    <div class="list-item" data-id="${project.id}">
                        ${imageUrl ? `<img src="${imageUrl}" alt="${project.title}">` : '<div class="placeholder-img">No image</div>'}
                        <div class="list-item-info">
                            <h4>${project.title}</h4>
                            <p>${summary.substring(0, 80)}${summary.length > 80 ? '...' : ''}</p>
                            ${date ? `<span class="date">${date}</span>` : ''}
                        </div>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editProject('${project.id}')">Edit</button>
                            <button class="btn-delete" onclick="deleteProject('${project.id}', '${project.title.replace(/'/g, "\\'")}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.editProject = function(projectId) {
            const project = allProjects.find(p => p.id === projectId);
            if (!project) return;
            currentEditingProject = project;
            projectIdField.value = project.id;
            projectTitleField.value = project.title || '';
            projectSummaryField.value = project.summary || '';
            projectContentField.value = project.content || project.description || '';
            const imageUrl = project.heroImage || project.imageUrl || project.image;
            if (imageUrl) { projectCurrentImage.src = imageUrl; projectCurrentImagePreview.style.display = 'block'; }
            else { projectCurrentImagePreview.style.display = 'none'; }
            projectFormMode.textContent = '‚úèÔ∏è Editing Project';
            projectFormMode.className = 'form-mode-indicator edit-mode';
            projectFormTitle.textContent = 'Edit Project';
            projectSubmitBtn.textContent = 'Update Project';
            projectCancelEditBtn.style.display = 'inline-block';
            projectForm.scrollIntoView({ behavior: 'smooth' });
        };

        function resetProjectForm() {
            currentEditingProject = null;
            projectForm.reset();
            projectIdField.value = '';
            projectCurrentImagePreview.style.display = 'none';
            projectFormMode.textContent = '‚ú® Creating New Project';
            projectFormMode.className = 'form-mode-indicator create-mode';
            projectFormTitle.textContent = 'Create New Project';
            projectSubmitBtn.textContent = 'Create Project';
            projectCancelEditBtn.style.display = 'none';
        }

        projectCancelEditBtn.addEventListener('click', resetProjectForm);

        window.deleteProject = async function(projectId, projectTitle) {
            if (!confirm(`Are you sure you want to delete "${projectTitle}"?`)) return;
            try {
                const response = await fetch('/.netlify/functions/deleteProject', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: projectId })
                });
                if (!response.ok) throw new Error('Failed to delete project');
                alert('Project deleted!');
                loadProjects();
                if (currentEditingProject && currentEditingProject.id === projectId) resetProjectForm();
            } catch (error) { console.error('Error:', error); alert(`Error: ${error.message}`); }
        };

        projectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const isEditing = !!projectIdField.value;
            const title = projectTitleField.value;
            const summary = projectSummaryField.value;
            const content = projectContentField.value;
            const imageFile = projectImageField.files[0];
            let imageUrl = '';
            if (isEditing && !imageFile && currentEditingProject) {
                imageUrl = currentEditingProject.heroImage || currentEditingProject.imageUrl || currentEditingProject.image || '';
            }
            try {
                projectSubmitBtn.disabled = true;
                projectSubmitBtn.textContent = isEditing ? 'Updating...' : 'Creating...';
                if (imageFile) imageUrl = await uploadImage(imageFile);
                if (isEditing) {
                    const response = await fetch('/.netlify/functions/updateProject', {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: projectIdField.value, title, summary, content, heroImage: imageUrl })
                    });
                    if (!response.ok) { const error = await response.json(); throw new Error(error.error || 'Failed to update.'); }
                    alert('Project updated!');
                } else {
                    const response = await fetch('/.netlify/functions/createProject', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, summary, content, imageUrl })
                    });
                    if (!response.ok) throw new Error('Failed to create project.');
                    alert('Project created!');
                }
                resetProjectForm();
                loadProjects();
            } catch (error) { console.error('Error:', error); alert(`Error: ${error.message}`); }
            finally { projectSubmitBtn.disabled = false; projectSubmitBtn.textContent = isEditing ? 'Update Project' : 'Create Project'; }
        });

        // ==================== BLOG POSTS ====================
        
        const blogForm = document.getElementById('blogForm');
        const blogList = document.getElementById('blog-list');
        const blogIdField = document.getElementById('blogId');
        const blogTitleField = document.getElementById('blogTitle');
        const blogSummaryField = document.getElementById('blogSummary');
        const blogContentField = document.getElementById('blogContent');
        const blogHeroImageField = document.getElementById('blogHeroImage');
        const blogCurrentImagePreview = document.getElementById('blogCurrentImagePreview');
        const blogCurrentImage = document.getElementById('blogCurrentImage');
        const blogFormMode = document.getElementById('blog-form-mode');
        const blogFormTitle = document.getElementById('blog-form-title');
        const blogSubmitBtn = document.getElementById('blogSubmitBtn');
        const blogCancelEditBtn = document.getElementById('blogCancelEdit');
        const blogInsertImageBtn = document.getElementById('blogInsertImageBtn');
        const blogInsertVideoBtn = document.getElementById('blogInsertVideoBtn');

        let currentEditingBlog = null;
        let allBlogPosts = [];

        blogInsertImageBtn.addEventListener('click', () => {
            currentInlineTarget = { btn: blogInsertImageBtn, textarea: blogContentField };
            inlineImageInput.click();
        });

        blogInsertVideoBtn.addEventListener('click', () => {
            currentVideoTarget = { btn: blogInsertVideoBtn, textarea: blogContentField };
            blogVideoInput.click();
        });

        async function loadBlogPosts() {
            blogList.innerHTML = '<div class="loading">Loading blog posts...</div>';
            try {
                const response = await fetch('/.netlify/functions/getBlogPosts');
                if (!response.ok) throw new Error('Failed to load blog posts');
                allBlogPosts = await response.json();
                renderBlogList();
            } catch (error) {
                console.error('Error loading blog posts:', error);
                blogList.innerHTML = '<div class="no-items">Error loading blog posts. Please refresh.</div>';
            }
        }

        function renderBlogList() {
            if (allBlogPosts.length === 0) {
                blogList.innerHTML = '<div class="no-items">No blog posts yet. Create your first one below!</div>';
                return;
            }
            const sorted = [...allBlogPosts].sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
            blogList.innerHTML = sorted.map(post => {
                const imageUrl = post.heroImage || '';
                const summary = post.summary || 'No summary';
                const date = post.createdAt ? new Date(post.createdAt).toLocaleDateString() : '';
                return `
                    <div class="list-item" data-id="${post.id}">
                        ${imageUrl ? `<img src="${imageUrl}" alt="${post.title}">` : '<div class="placeholder-img">No image</div>'}
                        <div class="list-item-info">
                            <h4>${post.title}</h4>
                            <p>${summary.substring(0, 80)}${summary.length > 80 ? '...' : ''}</p>
                            ${date ? `<span class="date">${date}</span>` : ''}
                        </div>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editBlogPost('${post.id}')">Edit</button>
                            <button class="btn-delete" onclick="deleteBlogPost('${post.id}', '${post.title.replace(/'/g, "\\'")}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.editBlogPost = function(postId) {
            const post = allBlogPosts.find(p => p.id === postId);
            if (!post) return;
            currentEditingBlog = post;
            blogIdField.value = post.id;
            blogTitleField.value = post.title || '';
            blogSummaryField.value = post.summary || '';
            blogContentField.value = post.content || '';
            if (post.heroImage) { blogCurrentImage.src = post.heroImage; blogCurrentImagePreview.style.display = 'block'; }
            else { blogCurrentImagePreview.style.display = 'none'; }
            blogFormMode.textContent = '‚úèÔ∏è Editing Blog Post';
            blogFormMode.className = 'form-mode-indicator edit-mode';
            blogFormTitle.textContent = 'Edit Blog Post';
            blogSubmitBtn.textContent = 'Update Blog Post';
            blogCancelEditBtn.style.display = 'inline-block';
            blogForm.scrollIntoView({ behavior: 'smooth' });
        };

        function resetBlogForm() {
            currentEditingBlog = null;
            blogForm.reset();
            blogIdField.value = '';
            blogCurrentImagePreview.style.display = 'none';
            blogFormMode.textContent = '‚ú® Creating New Blog Post';
            blogFormMode.className = 'form-mode-indicator create-mode';
            blogFormTitle.textContent = 'Create New Blog Post';
            blogSubmitBtn.textContent = 'Create Blog Post';
            blogCancelEditBtn.style.display = 'none';
        }

        blogCancelEditBtn.addEventListener('click', resetBlogForm);

        window.deleteBlogPost = async function(postId, postTitle) {
            if (!confirm(`Are you sure you want to delete "${postTitle}"?`)) return;
            try {
                const response = await fetch('/.netlify/functions/deleteBlogPost', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: postId })
                });
                if (!response.ok) throw new Error('Failed to delete blog post');
                alert('Blog post deleted!');
                loadBlogPosts();
                if (currentEditingBlog && currentEditingBlog.id === postId) resetBlogForm();
            } catch (error) { console.error('Error:', error); alert(`Error: ${error.message}`); }
        };

        blogForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const isEditing = !!blogIdField.value;
            const title = blogTitleField.value;
            const summary = blogSummaryField.value;
            const content = blogContentField.value;
            const imageFile = blogHeroImageField.files[0];
            let imageUrl = '';
            if (isEditing && !imageFile && currentEditingBlog) imageUrl = currentEditingBlog.heroImage || '';
            try {
                blogSubmitBtn.disabled = true;
                blogSubmitBtn.textContent = isEditing ? 'Updating...' : 'Creating...';
                if (imageFile) imageUrl = await uploadImage(imageFile);
                if (isEditing) {
                    const response = await fetch('/.netlify/functions/updateBlogPost', {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: blogIdField.value, title, summary, content, heroImage: imageUrl })
                    });
                    if (!response.ok) { const error = await response.json(); throw new Error(error.error || 'Failed to update.'); }
                    alert('Blog post updated!');
                } else {
                    const response = await fetch('/.netlify/functions/createBlogPost', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, summary, content, imageUrl })
                    });
                    if (!response.ok) throw new Error('Failed to create blog post.');
                    alert('Blog post created!');
                }
                resetBlogForm();
                loadBlogPosts();
            } catch (error) { console.error('Error:', error); alert(`Error: ${error.message}`); }
            finally { blogSubmitBtn.disabled = false; blogSubmitBtn.textContent = isEditing ? 'Update Blog Post' : 'Create Blog Post'; }
        });

        // ==================== ABOUT ME ====================
        
        const aboutTitleField = document.getElementById('aboutTitle');
        const aboutTaglineField = document.getElementById('aboutTagline');
        const aboutContentField = document.getElementById('aboutContent');
        const aboutProfilePreview = document.getElementById('aboutProfilePreview');
        const aboutProfileInput = document.getElementById('aboutProfileInput');
        const aboutProfileUploadBtn = document.getElementById('aboutProfileUploadBtn');
        const aboutProfileImageUrl = document.getElementById('aboutProfileImageUrl');
        const aboutSaveBtn = document.getElementById('aboutSaveBtn');
        const aboutLastSaved = document.getElementById('aboutLastSaved');
        const aboutInsertImageBtn = document.getElementById('aboutInsertImageBtn');
        const aboutInsertVideoBtn = document.getElementById('aboutInsertVideoBtn');

        // Timeline state
        let aboutTimeline = [];

        aboutInsertImageBtn.addEventListener('click', () => {
            currentInlineTarget = { btn: aboutInsertImageBtn, textarea: aboutContentField };
            inlineImageInput.click();
        });

        aboutInsertVideoBtn.addEventListener('click', () => {
            currentVideoTarget = { btn: aboutInsertVideoBtn, textarea: aboutContentField };
            blogVideoInput.click();
        });

        // Profile photo upload
        aboutProfileUploadBtn.addEventListener('click', () => aboutProfileInput.click());
        
        aboutProfileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                aboutProfileUploadBtn.disabled = true;
                aboutProfileUploadBtn.textContent = '‚è≥ Uploading...';
                const imageUrl = await uploadFile(file);
                aboutProfileImageUrl.value = imageUrl;
                aboutProfilePreview.style.backgroundImage = `url(${imageUrl})`;
                aboutProfileUploadBtn.textContent = '‚úÖ Uploaded!';
                setTimeout(() => { aboutProfileUploadBtn.textContent = 'üì∑ Upload Profile Photo'; aboutProfileUploadBtn.disabled = false; }, 1500);
            } catch (error) {
                console.error('Profile photo upload error:', error);
                alert(`Error: ${error.message}`);
                aboutProfileUploadBtn.textContent = 'üì∑ Upload Profile Photo';
                aboutProfileUploadBtn.disabled = false;
            }
            aboutProfileInput.value = '';
        });

        // Timeline editor render function
        function renderAboutTimelineEditor() {
            const list = document.getElementById('aboutTimelineList');
            if (!list) return;

            list.innerHTML = '';

            aboutTimeline.forEach((item, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'timeline-editor-item';
                wrapper.dataset.index = index;

                wrapper.innerHTML = `
                    <div class="timeline-editor-row">
                        <div style="flex: 0 0 140px;">
                            <div class="timeline-editor-label">Date</div>
                            <input type="text" class="timeline-date-input" value="${item.date || ''}" placeholder="e.g., 2019‚Äì2023" />
                        </div>
                        <div style="flex: 1;">
                            <div class="timeline-editor-label">Headline</div>
                            <input type="text" class="timeline-headline-input" value="${item.headline || ''}" placeholder="Job title or milestone" />
                        </div>
                    </div>
                    <div class="timeline-editor-row">
                        <div style="flex: 1;">
                            <div class="timeline-editor-label">Image URL (optional)</div>
                            <input type="text" class="timeline-image-input" value="${item.imageUrl || ''}" placeholder="/assets/uploads/image.jpg" />
                        </div>
                    </div>
                    <div>
                        <div class="timeline-editor-label">Body (Markdown)</div>
                        <textarea rows="3" class="timeline-body-input" placeholder="Description of this role or achievement...">${item.body || ''}</textarea>
                    </div>
                    <div style="display:flex; justify-content: space-between; align-items:center; margin-top:0.5rem;">
                        <div style="display:flex; gap:0.5rem;">
                            <button type="button" class="timeline-move-up btn-move">‚ñ≤ Up</button>
                            <button type="button" class="timeline-move-down btn-move">‚ñº Down</button>
                        </div>
                        <button type="button" class="timeline-editor-remove">üóë Remove</button>
                    </div>
                `;

                const removeBtn = wrapper.querySelector('.timeline-editor-remove');
                const moveUpBtn = wrapper.querySelector('.timeline-move-up');
                const moveDownBtn = wrapper.querySelector('.timeline-move-down');

                removeBtn.addEventListener('click', () => {
                    aboutTimeline.splice(index, 1);
                    renderAboutTimelineEditor();
                });

                moveUpBtn.addEventListener('click', () => {
                    if (index === 0) return;
                    const temp = aboutTimeline[index - 1];
                    aboutTimeline[index - 1] = aboutTimeline[index];
                    aboutTimeline[index] = temp;
                    renderAboutTimelineEditor();
                });

                moveDownBtn.addEventListener('click', () => {
                    if (index === aboutTimeline.length - 1) return;
                    const temp = aboutTimeline[index + 1];
                    aboutTimeline[index + 1] = aboutTimeline[index];
                    aboutTimeline[index] = temp;
                    renderAboutTimelineEditor();
                });

                list.appendChild(wrapper);
            });
        }

        // Add timeline entry button
        const timelineAddBtn = document.getElementById('aboutTimelineAddBtn');
        if (timelineAddBtn) {
            timelineAddBtn.addEventListener('click', () => {
                aboutTimeline.push({
                    id: 't' + Date.now(),
                    date: '',
                    headline: '',
                    imageUrl: '',
                    body: ''
                });
                renderAboutTimelineEditor();
            });
        }

        async function loadAbout() {
            try {
                const res = await fetch('/content/about.json', { cache: 'no-cache' });
                if (!res.ok) throw new Error('Failed to load about data');
                const data = await res.json();
                aboutTitleField.value = data.title || 'About';
                aboutTaglineField.value = data.tagline || '';
                aboutContentField.value = data.content || '';
                aboutProfileImageUrl.value = data.profileImage || '';
                if (data.profileImage) {
                    aboutProfilePreview.style.backgroundImage = `url(${data.profileImage})`;
                }
                if (data.updatedAt) {
                    aboutLastSaved.textContent = `Last saved: ${new Date(data.updatedAt).toLocaleString()}`;
                }
                // Load timeline
                aboutTimeline = Array.isArray(data.timeline) ? data.timeline : [];
                renderAboutTimelineEditor();
            } catch (error) {
                console.error('Error loading about:', error);
            }
        }

        aboutSaveBtn.addEventListener('click', async () => {
            const title = aboutTitleField.value;
            const tagline = aboutTaglineField.value;
            const content = aboutContentField.value;
            const profileImage = aboutProfileImageUrl.value || null;

            // Collect timeline values from editor
            const timelineList = document.getElementById('aboutTimelineList');
            if (timelineList) {
                const items = Array.from(timelineList.querySelectorAll('.timeline-editor-item'));
                aboutTimeline = items.map((el, idx) => {
                    return {
                        id: 't' + idx + '_' + Date.now(),
                        date: el.querySelector('.timeline-date-input').value.trim(),
                        headline: el.querySelector('.timeline-headline-input').value.trim(),
                        imageUrl: el.querySelector('.timeline-image-input').value.trim(),
                        body: el.querySelector('.timeline-body-input').value
                    };
                });
            }

            try {
                aboutSaveBtn.disabled = true;
                aboutSaveBtn.textContent = 'Saving...';

                const res = await fetch('/.netlify/functions/updateAbout', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, tagline, content, profileImage, timeline: aboutTimeline })
                });

                if (res.ok) {
                    const data = await res.json();
                    alert('About Page Updated!');
                    aboutLastSaved.textContent = `Last saved: ${new Date().toLocaleString()}`;
                } else {
                    const error = await res.json();
                    throw new Error(error.error || 'Failed to update');
                }
            } catch (error) {
                console.error('Error saving about:', error);
                alert(`Error: ${error.message}`);
            } finally {
                aboutSaveBtn.disabled = false;
                aboutSaveBtn.textContent = 'Save About Page';
            }
        });

        // ==================== RESUME ====================
        
        const resumeTitleField = document.getElementById('resumeTitle');
        const resumeIntroField = document.getElementById('resumeIntro');
        const resumeFileInput = document.getElementById('resumeFileInput');
        const resumeCurrentFile = document.getElementById('resumeCurrentFile');
        const resumeFileNameEl = document.getElementById('resumeFileName');
        const resumeFileLinkEl = document.getElementById('resumeFileLink');
        const resumeSaveBtn = document.getElementById('resumeSaveBtn');
        const resumeLastSaved = document.getElementById('resumeLastSaved');

        async function loadResume() {
            try {
                const res = await fetch('/content/resume.json');
                if (!res.ok) throw new Error('Failed to load resume data');
                const data = await res.json();
                
                resumeTitleField.value = data.title || 'Resume';
                resumeIntroField.value = data.intro || '';
                
                if (data.fileUrl) {
                    resumeCurrentFile.style.display = 'block';
                    resumeFileNameEl.textContent = data.fileName || 'resume';
                    resumeFileLinkEl.href = data.fileUrl;
                } else {
                    resumeCurrentFile.style.display = 'none';
                }
                
                if (data.updatedAt) {
                    resumeLastSaved.textContent = `Last saved: ${new Date(data.updatedAt).toLocaleString()}`;
                }
            } catch (error) {
                console.error('Error loading resume:', error);
            }
        }

        resumeSaveBtn.addEventListener('click', async () => {
            try {
                resumeSaveBtn.disabled = true;
                resumeSaveBtn.textContent = 'Saving...';

                let fileUrl = null;
                let fileName = null;

                // Upload new file if one is selected
                const file = resumeFileInput.files[0];
                if (file) {
                    // Reuse the existing upload function used for images/videos
                    const uploadedUrl = await uploadFile(file);
                    fileUrl = uploadedUrl;
                    fileName = file.name;
                } else {
                    // If no new file, use current data from resume.json
                    try {
                        const res = await fetch('/content/resume.json');
                        const data = await res.json();
                        fileUrl = data.fileUrl || '';
                        fileName = data.fileName || '';
                    } catch (e) {
                        fileUrl = '';
                        fileName = '';
                    }
                }

                const body = {
                    title: resumeTitleField.value || 'Resume',
                    intro: resumeIntroField.value || '',
                    fileUrl,
                    fileName
                };

                const res = await fetch('/.netlify/functions/updateResume', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || 'Failed to update resume.');
                }

                alert('Resume page updated!');
                resumeLastSaved.textContent = 'Last saved: ' + new Date().toLocaleString();
                resumeFileInput.value = '';
                loadResume();
            } catch (err) {
                console.error('Error saving resume:', err);
                alert('Error: ' + err.message);
            } finally {
                resumeSaveBtn.disabled = false;
                resumeSaveBtn.textContent = 'Save Resume Page';
            }
        });

        // ==================== CONTACT ====================
        
        const contactTitleField = document.getElementById('contactTitle');
        const contactIntroField = document.getElementById('contactIntroInput');
        const contactEmailField = document.getElementById('contactEmail');
        const contactBodyField = document.getElementById('contactBodyInput');
        const contactSaveBtn = document.getElementById('contactSaveBtn');
        const contactLastSaved = document.getElementById('contactLastSaved');

        async function loadContact() {
            try {
                const res = await fetch('/content/contact.json', { cache: 'no-cache' });
                if (!res.ok) throw new Error('Failed to load contact data');
                const data = await res.json();
                
                contactTitleField.value = data.title || 'Contact';
                contactIntroField.value = data.intro || '';
                contactEmailField.value = data.email || '';
                contactBodyField.value = data.body || '';
                
                if (data.updatedAt) {
                    contactLastSaved.textContent = `Last saved: ${new Date(data.updatedAt).toLocaleString()}`;
                }
            } catch (error) {
                console.error('Error loading contact:', error);
            }
        }

        contactSaveBtn.addEventListener('click', async () => {
            const payload = {
                title: contactTitleField.value.trim() || 'Contact',
                intro: contactIntroField.value.trim(),
                email: contactEmailField.value.trim(),
                body: contactBodyField.value
            };

            try {
                contactSaveBtn.disabled = true;
                contactSaveBtn.textContent = 'Saving...';

                const res = await fetch('/.netlify/functions/updateContact', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to save contact page');
                }

                const data = await res.json();

                if (data.data && data.data.updatedAt) {
                    contactLastSaved.textContent = `Last saved: ${new Date(data.data.updatedAt).toLocaleString()}`;
                }

                alert('Contact page saved successfully!');
            } catch (error) {
                console.error('Error saving contact:', error);
                alert('Failed to save contact page: ' + error.message);
            } finally {
                contactSaveBtn.disabled = false;
                contactSaveBtn.textContent = 'Save Contact Page';
            }
        });

        // ==================== SITE SETTINGS ====================
        
        const siteTitleField = document.getElementById('siteTitle');
        const siteSubtitleField = document.getElementById('siteSubtitle');
        const headerBgField = document.getElementById('headerBg');
        const headerTextField = document.getElementById('headerText');
        const pageBgField = document.getElementById('pageBg');
        const cardBgField = document.getElementById('cardBg');
        const siteSaveBtn = document.getElementById('siteSaveBtn');
        const siteLastSaved = document.getElementById('siteLastSaved');

        async function loadSiteSettings() {
            try {
                const res = await fetch('/content/site.json');
                if (!res.ok) return;
                const data = await res.json();
                siteTitleField.value = data.siteTitle || 'MB Engineering';
                siteSubtitleField.value = data.siteSubtitle || '';
                headerBgField.value = data.headerBg || '#333333';
                headerTextField.value = data.headerText || '#ffffff';
                pageBgField.value = data.pageBg || '#f5f5f5';
                cardBgField.value = data.cardBg || '#ffffff';
                if (data.updatedAt) {
                    siteLastSaved.textContent = `Last saved: ${new Date(data.updatedAt).toLocaleString()}`;
                }
            } catch (err) {
                console.error('Error loading site settings:', err);
            }
        }

        siteSaveBtn.addEventListener('click', async () => {
            try {
                siteSaveBtn.disabled = true;
                siteSaveBtn.textContent = 'Saving...';

                const payload = {
                    siteTitle: siteTitleField.value,
                    siteSubtitle: siteSubtitleField.value,
                    headerBg: headerBgField.value,
                    headerText: headerTextField.value,
                    pageBg: pageBgField.value,
                    cardBg: cardBgField.value
                };

                const res = await fetch('/.netlify/functions/updateSiteSettings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const error = await res.json().catch(() => ({}));
                    throw new Error(error.error || 'Failed to update site settings');
                }

                const data = await res.json();
                siteLastSaved.textContent = `Last saved: ${new Date(data.updatedAt).toLocaleString()}`;
                alert('Site settings updated!');
            } catch (err) {
                console.error('Error saving site settings:', err);
                alert(`Error: ${err.message}`);
            } finally {
                siteSaveBtn.disabled = false;
                siteSaveBtn.textContent = 'Save Site Settings';
            }
        });

        // ==================== TAB SWITCHING ====================
        
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                
                if (tab.dataset.tab === 'blog') loadBlogPosts();
                else if (tab.dataset.tab === 'about') loadAbout();
                else if (tab.dataset.tab === 'resume') loadResume();
                else if (tab.dataset.tab === 'contact') loadContact();
                else if (tab.dataset.tab === 'site') loadSiteSettings();
            });
        });

        // ==================== AUTH ====================
        
        const handleUserState = (user) => {
            if (user) {
                loginContainer.style.display = 'none';
                adminContent.style.display = 'block';
                userInfo.textContent = `Logged in as ${user.email}`;
                loadProjects();
            } else {
                loginContainer.style.display = 'block';
                adminContent.style.display = 'none';
                userInfo.textContent = '';
            }
        };

        netlifyIdentity.init();
        netlifyIdentity.on('init', handleUserState);
        netlifyIdentity.on('login', handleUserState);
        netlifyIdentity.on('logout', () => handleUserState(null));

        loginButton.addEventListener('click', () => netlifyIdentity.open());
        logoutButton.addEventListener('click', () => netlifyIdentity.logout());
    });
    </script>
</body>
</html>
